<!-- Scraping Container -->
<div class="scraping-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="header-icon">find_in_page</mat-icon>
      <div class="header-text">
        <h1 class="page-title">Revision History Scraping</h1>
        <p class="page-subtitle">Extract assignee and status changes from Airtable</p>
      </div>
    </div>
  </div>

  <!-- Two-Column Layout -->
  <div class="scraping-layout">
    <!-- Left Column: Actions and Settings -->
    <div class="scraping-column left-column">
      <!-- Info Card -->
      <mat-card class="info-card">
        <mat-card-content>
          <div class="info-content">
            <mat-icon>info</mat-icon>
            <div>
              <p><strong>Custom Scraping for Revision History</strong></p>
              <p>Uses browser automation to retrieve assignee and status changes from Airtable's revision history (not
                available via API).</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Cookie Status Card -->
      <mat-card class="cookie-card">
        <mat-card-header>
          <div class="card-header-content">
            <mat-icon class="section-icon">cookie</mat-icon>
            <div class="header-text">
              <mat-card-title>Cookie Status</mat-card-title>
              <mat-card-subtitle>Authentication for scraping</mat-card-subtitle>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content>
          <!-- Status Display -->
          <div class="status-display" [class.status-valid]="cookieStatus.valid"
            [class.status-invalid]="!cookieStatus.valid">
            <div class="status-indicator">
              <div class="status-pulse" *ngIf="cookieStatus.valid"></div>
              <mat-icon>{{ cookieStatus.valid ? 'check_circle' : 'cancel' }}</mat-icon>
            </div>
            <div class="status-details">
              <div class="status-main">{{ getCookieStatusText() }}</div>
              <div class="status-sub" *ngIf="cookieStatus.lastValidated">
                Last validated {{ formatDate(cookieStatus.lastValidated) }}
              </div>
              <div class="status-sub" *ngIf="!cookieStatus.hasCookies">
                Please authenticate in Authentication page
              </div>
            </div>
          </div>

          <!-- Warning Banner -->
          <div class="warning-banner" *ngIf="!cookieStatus.hasCookies || !cookieStatus.valid">
            <mat-icon>warning_amber</mat-icon>
            <div>
              <strong>Authentication Required</strong>
              <p>Please authenticate in the Authentication page before fetching revision history.</p>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-raised-button color="primary" class="primary-button" (click)="validateCookies()"
            [disabled]="loading" matTooltip="Check if stored cookies are still valid">
            <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
            <mat-icon *ngIf="!loading">verified</mat-icon>
            Validate Cookies
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Fetch Actions Card -->
      <mat-card class="action-card">
        <mat-card-header>
          <div class="card-header-content">
            <mat-icon class="section-icon">play_arrow</mat-icon>
            <div class="header-text">
              <mat-card-title>Fetch Revision History</mat-card-title>
              <mat-card-subtitle>Process up to 200 pages automatically</mat-card-subtitle>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content>


          <!-- Action Buttons -->
          <div class="action-buttons">
            <button mat-raised-button color="primary" class="primary-button fetch-button" (click)="fetchAllRevisions()"
              [disabled]="!canFetchRevisions()" matTooltip="Start fetching revision history for all pages">
              <mat-spinner *ngIf="fetchingRevisions" diameter="20" class="button-spinner"></mat-spinner>
              <mat-icon *ngIf="!fetchingRevisions">cloud_download</mat-icon>
              {{ fetchingRevisions ? 'Fetching...' : 'Fetch All Revision Histories' }}
            </button>
          </div>

          <!-- Progress Bar -->
          <mat-progress-bar *ngIf="fetchingRevisions" mode="indeterminate" color="primary">
          </mat-progress-bar>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Right Column: Statistics -->
    <div class="scraping-column right-column">
      <!-- Statistics Card -->
      <mat-card class="stats-card">
        <mat-card-header>
          <div class="card-header-content">
            <mat-icon class="section-icon">analytics</mat-icon>
            <div class="header-text">
              <mat-card-title>Revision Statistics</mat-card-title>
              <mat-card-subtitle>Current data summary</mat-card-subtitle>
            </div>
          </div>
          <button mat-icon-button (click)="refreshStats()" matTooltip="Refresh statistics" class="header-action">
            <mat-icon>refresh</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>description</mat-icon>
              </div>
              <div class="stat-value">{{ revisionStats.totalPages || 0 }}</div>
              <div class="stat-label">Pages Processed</div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>change_circle</mat-icon>
              </div>
              <div class="stat-value">{{ revisionStats.totalRevisions || 0 }}</div>
              <div class="stat-label">Total Revisions</div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>person</mat-icon>
              </div>
              <div class="stat-value">{{ revisionStats.assigneeChanges || 0 }}</div>
              <div class="stat-label">Assignee Changes</div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>flag</mat-icon>
              </div>
              <div class="stat-value">{{ revisionStats.statusChanges || 0 }}</div>
              <div class="stat-label">Status Changes</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Help Card -->
      <mat-card class="help-card">
        <mat-card-header>
          <div class="card-header-content">
            <mat-icon class="section-icon">help_outline</mat-icon>
            <div class="header-text">
              <mat-card-title>How It Works</mat-card-title>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div class="help-content">
            <div class="help-section">
              <h3>
                <mat-icon>auto_fix_high</mat-icon>
                Scraping Process
              </h3>
              <ol>
                <li>Validates cookies are still active</li>
                <li>Fetches all pages from MongoDB</li>
                <li>Makes requests to Airtable's revision history endpoint</li>
                <li>Parses HTML response to extract changes</li>
                <li>Filters for assignee and status changes only</li>
                <li>Stores structured data in MongoDB</li>
              </ol>
            </div>

            <div class="help-section">
              <h3>
                <mat-icon>visibility</mat-icon>
                View Results
              </h3>
              <p>After processing completes, view the revision history data in the table below or in the "Data View"
                section.</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- AG Grid Table (Full Width) -->
  <mat-card class="grid-card" *ngIf="rowData.length > 0">
    <mat-card-header>
      <div class="card-header-content">
        <mat-icon class="section-icon">table_view</mat-icon>
        <div class="header-text">
          <mat-card-title>
            Revision History Data
            <span class="record-count" *ngIf="rowData.length > 0">
              ({{ rowData.length }} records)
            </span>
          </mat-card-title>
          <mat-card-subtitle>Filterable, sortable, and exportable</mat-card-subtitle>
        </div>
      </div>

      <!-- Grid Actions -->
      <div class="grid-actions">
        <button mat-icon-button (click)="exportToCSV()" matTooltip="Export to CSV" class="grid-action-button">
          <mat-icon>file_download</mat-icon>
        </button>
        <button mat-icon-button (click)="exportToExcel()" matTooltip="Export to Excel" class="grid-action-button">
          <mat-icon>table_chart</mat-icon>
        </button>
        <button mat-icon-button (click)="clearFilters()" matTooltip="Clear filters" class="grid-action-button">
          <mat-icon>filter_alt_off</mat-icon>
        </button>
        <button mat-icon-button (click)="resetGrid()" matTooltip="Reset grid" class="grid-action-button">
          <mat-icon>restart_alt</mat-icon>
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>
      <!-- AG Grid -->
      <ag-grid-angular class="ag-theme-material grid-container" [columnDefs]="columnDefs" [rowData]="rowData"
        [gridOptions]="gridOptions" (gridReady)="onGridReady($event)">
      </ag-grid-angular>
    </mat-card-content>
  </mat-card>

  <!-- Empty State -->
  <mat-card class="empty-card" *ngIf="rowData.length === 0">
    <mat-card-content>
      <div class="empty-state">
        <mat-icon>table_rows</mat-icon>
        <p>No revision history data yet</p>
        <p class="hint">Click "Fetch All Revision Histories" to start processing pages</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>